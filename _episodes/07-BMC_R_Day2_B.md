---
# Please do not edit this file directly; it is auto generated.
# Instead, please edit 07-BMC_R_Day2_B.md in _episodes_rmd/
title: "Data Wrangling"
author: "Nicholas Ho, Richard Morris, Darya Vanichkina, Maryam Montazerolghaem"
keypoints:
- R has a large community of developers creating power tools for data analysis
- Tidyverse is a great data wrangling suite of functions
- Use haven to read in your SPSS, STATA, etc files
- Use dplyr to perform the common data manipulations
objectives:
- Introduction into tidyverse
- Introduction into the grammar of tidyverse
questions: Tidyverse
source: Rmd
subtitle: Day 2
teaching: 50
exercises: 25
---


## Data wrangling

![tidyverse](../fig/tidyverse_website.png)


So far, we've been using R's base functions to perform our data wrangling and manipulation. 

The advantage of working with R is that R has a large community of developers creating free and powerful tools (called libraries) which we can use. This includes the latest data wrangling, visualisation, statistical testing and machine learning tools.

I would highly encourage you to learn to use the [tidyverse](https://www.tidyverse.org/) collection of data wrangling and visualisation tools. These are excellent tools that allows you to write elegent, legible code that gets your data into the right shape prior to analysis.


~~~
# load tidyverse
library(tidyverse)
~~~
{: .language-r}



~~~
-- Attaching packages ---------------------------------- tidyverse 1.2.1 --
~~~
{: .output}



~~~
<U+221A> ggplot2 3.0.0     <U+221A> purrr   0.2.5
<U+221A> tibble  1.4.2     <U+221A> dplyr   0.7.6
<U+221A> tidyr   0.8.1     <U+221A> stringr 1.2.0
<U+221A> readr   1.1.1     <U+221A> forcats 0.3.0
~~~
{: .output}



~~~
-- Conflicts ------------------------------------- tidyverse_conflicts() --
x dplyr::filter() masks stats::filter()
x dplyr::lag()    masks stats::lag()
~~~
{: .output}


## haven

![haven](../fig/haven_logo.png)

haven is a package within the tidyverse that allows you to read in data from different sources. For example, if our autism dataset was saved as an .sav file (SPSS), we can use `haven` to read that in.

TODO - Darya, I'm having trouble reading in the missing values from SPSS. Haven doesn't recognise my SPSS user-specified missing values...Would you know how to get this working? My hack is to run austism.data.spss[which(austism.data.spss == "NA", arr.ind = TRUE)] <- NA but its more complicated and confusing for our students than need be 

~~~
# load haven
library(haven)
#autism.data <- read_spss("data/autism_data.sav") TODO

autism.data <- read.csv(file = "data/autism_pids.csv",
                        header = TRUE,
                        sep = ",")
~~~
{: .language-r}


Next, we'll step into one of the most popular tidyverse package called [dplyr](https://dplyr.tidyverse.org/).

## dpylr

![dplyr](../fig/hex-dplyr.jpeg)

`dpylr` allows you to perform some of the most common data manipulation tasks you'll encounter in R. The background of the `dplyr` package is that it is a "grammar" of data manipulation and that its functions are a set of verbs.

You will also notice that the spelling follows British spelling rather than American (Hadley Wickham, author and maintainer of the tidyverse, is from New Zealand), but they can actually be used interchangeably. For example, `summarise()` and `summarize()` perform the same function.

### select()
The `select()` function allows you to pick or remove variables based on their names. Note that you do not use `"` nor `'` to wrap the column names as you would with a base R function


~~~
# select just the age, gender and result columns from autism.data
selected.autism.data <- select(autism.data, age, gender, result)
head(selected.autism.data)
~~~
{: .language-r}



~~~
  age gender result
1  26      f      6
2  24      m      5
3  27      m      8
4  35      f      6
5  40      f      2
6  36      m      9
~~~
{: .output}



~~~
# select all columns except for ethnicity and country
selected.autism.data <- select(autism.data, -ethnicity, -country)
head(selected.autism.data)
~~~
{: .language-r}



~~~
  id A1_Score A2_Score A3_Score A4_Score A5_Score A6_Score A7_Score
1  1        1        1        1        1        0        0        1
2  2        1        1        0        1        0        0        0
3  3        1        1        0        1        1        0        1
4  4        1        1        0        1        0        0        1
5  5        1        0        0        0        0        0        0
6  6        1        1        1        1        1        0        1
  A8_Score A9_Score A10_Score age gender jaundice autism used_app_before
1        1        0         0  26      f       no     no              no
2        1        0         1  24      m       no    yes              no
3        1        1         1  27      m      yes    yes              no
4        1        0         1  35      f       no    yes              no
5        1        0         0  40      f       no     no              no
6        1        1         1  36      m      yes     no              no
  result    age_desc relation Class.ASD        pids
1      6 18 and more     Self        NO PatientID_1
2      5 18 and more     Self        NO PatientID_2
3      8 18 and more   Parent       YES PatientID_3
4      6 18 and more     Self        NO PatientID_4
5      2 18 and more     <NA>        NO PatientID_5
6      9 18 and more     Self       YES PatientID_6
~~~
{: .output}

The tidyverse allows you to pipe functions together to create a chain to data manipulations. This allows you to redirect the output of one function into another one. Those familiar with bash or *nix will be familiar with piping with `|`. Here, we use `%>%` to pipe.

This makes each step discrete and helps immensely with readability. Also reduces your need to create temporary variables.


~~~
autism.data %>% select(age, gender, result) %>% head()
~~~
{: .language-r}



~~~
  age gender result
1  26      f      6
2  24      m      5
3  27      m      8
4  35      f      6
5  40      f      2
6  36      m      9
~~~
{: .output}

Or let's make this more legible

~~~
autism.data %>%
  select(age, gender, result) %>%
  head()
~~~
{: .language-r}



~~~
  age gender result
1  26      f      6
2  24      m      5
3  27      m      8
4  35      f      6
5  40      f      2
6  36      m      9
~~~
{: .output}

Redirect the output of this chain of pipes into a new dataframe

~~~
autism.data %>%
  select(age, gender, result) -> selected.autism.data
~~~
{: .language-r}


### filter()
The `filter()` function allows you to filter rows of your dataset that match some condition. We can also combine this with some of R' base functions. Here, we'll use `head()` to restrict the output number of rows

~~~
autism.data %>%
  filter(age == 17) %>%
  head()
~~~
{: .language-r}



~~~
Warning: package 'bindrcpp' was built under R version 3.4.4
~~~
{: .error}



~~~
  id A1_Score A2_Score A3_Score A4_Score A5_Score A6_Score A7_Score
1  7        0        1        0        0        0        0        0
2 10        1        1        1        1        0        1        1
3 13        0        1        1        1        1        1        0
4 14        1        0        0        0        0        0        1
5 15        1        0        0        0        0        0        1
6 85        1        1        0        0        0        0        0
  A8_Score A9_Score A10_Score age gender      ethnicity jaundice autism
1        1        0         0  17      f          Black       no     no
2        1        1         0  17      m          Asian      yes    yes
3        0        1         0  17      f           <NA>       no     no
4        1        0         1  17      m           <NA>       no     no
5        1        0         1  17      f           <NA>       no     no
6        0        0         0  17      f White-European       no     no
        country used_app_before result    age_desc
1 United States              no      2 18 and more
2       Bahamas              no      8 18 and more
3       Bahamas              no      6 18 and more
4       Austria              no      4 18 and more
5     Argentina              no      4 18 and more
6   New Zealand              no      2 18 and more
                  relation Class.ASD         pids
1                     Self        NO  PatientID_7
2 Health care professional       YES PatientID_10
3                     <NA>        NO PatientID_13
4                     <NA>        NO PatientID_14
5                     <NA>        NO PatientID_15
6                     Self        NO PatientID_85
~~~
{: .output}

Combine this with the `select()` function to select only the age, gender and country of the 17 year olds in the autism dataset

~~~
autism.data %>%
  filter(age == 17) %>%
  select(age, gender, country) %>%
  head()
~~~
{: .language-r}



~~~
  age gender       country
1  17      f United States
2  17      m       Bahamas
3  17      f       Bahamas
4  17      m       Austria
5  17      f     Argentina
6  17      f   New Zealand
~~~
{: .output}

What are the counts for countries of the 17 year olds in the autism dataset

~~~
autism.data %>%
  filter(age == 17) %>%
  select(country) %>%
  table()
~~~
{: .language-r}



~~~
.
         Afghanistan        AmericanSamoa               Angola 
                   0                    0                    0 
           Argentina              Armenia                Aruba 
                   1                    0                    0 
           Australia              Austria           Azerbaijan 
                   0                    1                    0 
             Bahamas           Bangladesh              Belgium 
                   2                    0                    0 
             Bolivia               Brazil              Burundi 
                   0                    0                    0 
              Canada                Chile                China 
                   1                    0                    0 
          Costa Rica               Cyprus       Czech Republic 
                   0                    0                    0 
             Ecuador                Egypt             Ethiopia 
                   0                    0                    0 
             Finland               France              Germany 
                   0                    0                    0 
           Hong Kong              Iceland                India 
                   0                    0                    1 
           Indonesia                 Iran                 Iraq 
                   0                    0                    0 
             Ireland                Italy                Japan 
                   0                    0                    0 
              Jordan           Kazakhstan              Lebanon 
                   0                    0                    0 
            Malaysia               Mexico                Nepal 
                   0                    0                    0 
         Netherlands          New Zealand            Nicaragua 
                   1                    4                    0 
               Niger                 Oman             Pakistan 
                   0                    0                    0 
         Philippines             Portugal              Romania 
                   0                    0                    1 
              Russia         Saudi Arabia               Serbia 
                   0                    0                    0 
        Sierra Leone         South Africa                Spain 
                   0                    0                    0 
           Sri Lanka               Sweden                Tonga 
                   0                    0                    0 
              Turkey              Ukraine United Arab Emirates 
                   0                    0                    1 
      United Kingdom        United States              Uruguay 
                   1                    4                    0 
            Viet Nam 
                   0 
~~~
{: .output}

### arrange()
The `arrange()` function allows you to reorder the rows of your dataset

~~~
autism.data %>%
  arrange(age) %>%
  head()
~~~
{: .language-r}



~~~
  id A1_Score A2_Score A3_Score A4_Score A5_Score A6_Score A7_Score
1  7        0        1        0        0        0        0        0
2 10        1        1        1        1        0        1        1
3 13        0        1        1        1        1        1        0
4 14        1        0        0        0        0        0        1
5 15        1        0        0        0        0        0        1
6 85        1        1        0        0        0        0        0
  A8_Score A9_Score A10_Score age gender      ethnicity jaundice autism
1        1        0         0  17      f          Black       no     no
2        1        1         0  17      m          Asian      yes    yes
3        0        1         0  17      f           <NA>       no     no
4        1        0         1  17      m           <NA>       no     no
5        1        0         1  17      f           <NA>       no     no
6        0        0         0  17      f White-European       no     no
        country used_app_before result    age_desc
1 United States              no      2 18 and more
2       Bahamas              no      8 18 and more
3       Bahamas              no      6 18 and more
4       Austria              no      4 18 and more
5     Argentina              no      4 18 and more
6   New Zealand              no      2 18 and more
                  relation Class.ASD         pids
1                     Self        NO  PatientID_7
2 Health care professional       YES PatientID_10
3                     <NA>        NO PatientID_13
4                     <NA>        NO PatientID_14
5                     <NA>        NO PatientID_15
6                     Self        NO PatientID_85
~~~
{: .output}

### mutate()
The `mutate()` function adds new columns for your data set

~~~
autism.data %>%
  mutate(result_squared = result^2) %>%
  head()
~~~
{: .language-r}



~~~
  id A1_Score A2_Score A3_Score A4_Score A5_Score A6_Score A7_Score
1  1        1        1        1        1        0        0        1
2  2        1        1        0        1        0        0        0
3  3        1        1        0        1        1        0        1
4  4        1        1        0        1        0        0        1
5  5        1        0        0        0        0        0        0
6  6        1        1        1        1        1        0        1
  A8_Score A9_Score A10_Score age gender      ethnicity jaundice autism
1        1        0         0  26      f White-European       no     no
2        1        0         1  24      m         Latino       no    yes
3        1        1         1  27      m         Latino      yes    yes
4        1        0         1  35      f White-European       no    yes
5        1        0         0  40      f           <NA>       no     no
6        1        1         1  36      m         Others      yes     no
        country used_app_before result    age_desc relation Class.ASD
1 United States              no      6 18 and more     Self        NO
2        Brazil              no      5 18 and more     Self        NO
3         Spain              no      8 18 and more   Parent       YES
4 United States              no      6 18 and more     Self        NO
5         Egypt              no      2 18 and more     <NA>        NO
6 United States              no      9 18 and more     Self       YES
         pids result_squared
1 PatientID_1             36
2 PatientID_2             25
3 PatientID_3             64
4 PatientID_4             36
5 PatientID_5              4
6 PatientID_6             81
~~~
{: .output}

You can also use `mutate()` to remove or edit existing columns

~~~
autism.data %>%
  mutate(age_desc = NULL, # this is to remove the age_desc column
         result = result + 1, # edit the existing result column
         agerank = rank(age)) %>% # add a new column called agerank
  head()
~~~
{: .language-r}



~~~
  id A1_Score A2_Score A3_Score A4_Score A5_Score A6_Score A7_Score
1  1        1        1        1        1        0        0        1
2  2        1        1        0        1        0        0        0
3  3        1        1        0        1        1        0        1
4  4        1        1        0        1        0        0        1
5  5        1        0        0        0        0        0        0
6  6        1        1        1        1        1        0        1
  A8_Score A9_Score A10_Score age gender      ethnicity jaundice autism
1        1        0         0  26      f White-European       no     no
2        1        0         1  24      m         Latino       no    yes
3        1        1         1  27      m         Latino      yes    yes
4        1        0         1  35      f White-European       no    yes
5        1        0         0  40      f           <NA>       no     no
6        1        1         1  36      m         Others      yes     no
        country used_app_before result relation Class.ASD        pids
1 United States              no      7     Self        NO PatientID_1
2        Brazil              no      6     Self        NO PatientID_2
3         Spain              no      9   Parent       YES PatientID_3
4 United States              no      7     Self        NO PatientID_4
5         Egypt              no      3     <NA>        NO PatientID_5
6 United States              no     10     Self       YES PatientID_6
  agerank
1   328.5
2   270.5
3   358.0
4   530.0
5   595.5
6   545.0
~~~
{: .output}


### summarise() and group_by()
The `summarise()` function reduces down multiple values into one summary statistic. To do so, we need to tell R which groups we're interested in summarising our data into. To do so, we need to use the `group_by()` function prior to calling `summarise()`

~~~
autism.data %>%
  group_by(Class.ASD) %>%
  summarise(meanage = mean(age, na.rm = TRUE),
            count = n())
~~~
{: .language-r}



~~~
# A tibble: 2 x 3
  Class.ASD meanage count
  <fct>       <dbl> <int>
1 NO           28.4   514
2 YES          31.3   189
~~~
{: .output}

You can group by more than one variable

~~~
autism.data %>%
  group_by(Class.ASD, gender) %>%
  summarise(mean.age = mean(age, na.rm = TRUE),
            max.age = max(age, na.rm = TRUE),
            min.age = min(age, na.rm = TRUE),
            count = n())
~~~
{: .language-r}



~~~
# A tibble: 4 x 6
# Groups:   Class.ASD [?]
  Class.ASD gender mean.age max.age min.age count
  <fct>     <fct>     <dbl>   <dbl>   <dbl> <int>
1 NO        f          28.7      61      17   233
2 NO        m          28.1      64      17   281
3 YES       f          31.3      60      17   103
4 YES       m          31.3      61      17    86
~~~
{: .output}


> ## Section quiz
>
> 1. Create a summary table for mean 'result' after grouping by gender, autism class and family history of autism
>
> 2. Do the same as Q1 and now arrange from the lowest mean 'result' to the highest
>
> {: .source}
>
> > ## Solution
> >
> > 1. Despite the word of the question, we will first 'group_by' and then 'summarise'
> >
> > ~~~
> > autism.data %>% 
> >   group_by(gender, Class.ASD, autism) %>% 
> >   summarise(mean.result = mean(result))
> > ~~~
> > 2. We need to add in an 'arrange' at the end of our command 
> >
> > ~~~
> > autism.data %>% 
> >   group_by(gender, Class.ASD, autism) %>% 
> >   summarise(mean.result = mean(result)) %>%
> >   arrange(mean.result)
> > ~~~
> > {: .output}
> {: .solution}
{: .challenge}

